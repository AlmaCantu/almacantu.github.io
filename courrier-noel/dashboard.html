<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Borel&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="style.css">

  <title>Dashboard</title>
</head>
<body>

<script>
  // Guard (démo)
  if (sessionStorage.getItem("loggedIn") !== "true") {
    window.location.href = "index.html";
  }
</script>

<header class="topbar">
  <div>
    <div class="brand">
      <button class="menu-btn" onclick="openMenu()">☰</button>
      Lettre au Père Noël
    </div>
  </div>
  <div class="header-actions">
    <button class="btn" onclick="openHelp()"><i class="fa-regular fa-circle-question"></i></button>
    <button class="btn" onclick="logout()"><i class="fa-solid fa-arrow-right-from-bracket"></i></button>
  </div>
</header>

<div class="layout">
  <!-- Desktop sidebar -->
  <aside class="sidebar">
    <!-- <div class="nav-title">Utilisateurs</div> -->
    <nav class="nav" id="desktopNav"></nav>
  </aside>

  <!-- Main content -->
  <main>
    <section class="panel">
      <!-- <h1 id="title"></h1>
      <p class="hint" id="hint"></p> -->
      <div class="letter-body">
        <p>
          Cher Père Noël,
        </p>
      
        <p>
          J’espère que tu vas bien avec tous les cadeaux à préparer.
          Cette année, j’ai essayé d’être sage et de faire de mon mieux.
        </p>
      
        <p>
          Pour Noël, j’aimerais beaucoup recevoir les quelques cadeaux suivants :
        </p>
  
        <div class="list" id="giftList"></div>
  
        <div class="addRow">
          <button class="plusBtn" id="addBtn" title="Ajouter un cadeau">+</button>
          <input class="giftInput" id="giftInput" placeholder="Ajouter un cadeau..." />
        </div>
      </div>

      <div class="letter-footer">
        <p>
          Merci pour tout le travail que tu fais chaque année.
        </p>
      
        <p>
          Mille bisous,
        </p>
      
        <p id="signature"></p>
      </div>
      
    </section>
  </main>
</div>

<!-- Mobile drawer -->
<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<aside class="drawer" id="drawer">
  <nav class="nav" id="mobileNav"></nav>
</aside>

<!-- Help popup -->
<div class="modal-overlay" id="helpModal" onclick="closeHelp()">
  <div class="modal" onclick="event.stopPropagation()">
    <h2>Instructions</h2>

    <p>
      <!-- This page is a demo dashboard. Use the menu to navigate and read the content -->
      <!-- inside the letter panel. -->
    </p>

    <div>
      <p><i class="stateBtn fa-regular fa-square green"></i>&nbsp;Idée de cadeau disponible</p>
      <p><i class="stateBtn fa-solid fa-gift red"></i>&nbsp;Cadeau sélectionné par toi</p>
      <p><i class="stateBtn fa-solid fa-gift disabled"></i>&nbsp;Cadeau sélectionné par une autre personne</p>
      <p><i class="stateBtn fa-solid fa-cubes-stacked green"></i>&nbsp;Cadeau sélectionné par d'autres mais ouvert au partage</p>
      <p><i class="stateBtn fa-solid fa-cubes-stacked red"></i>&nbsp;Cadeau sélectionné par toi et ouvert au partage</p>
    </div>

    <button class="btn" onclick="closeHelp()">x</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

  // Storage key
  const STORAGE_KEY = "cadeauxData_v1";

  // Données
  const SUPABASE_URL = sessionStorage.getItem("SUPABASE_URL");
  const SUPABASE_ANON_KEY = sessionStorage.getItem("SUPABASE_ANON_KEY");
  const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Utilisateur connecté
  const user_id = sessionStorage.getItem("user_id");
  console.log(user_id);
  let selectedUser = "";

  // Menu
  let menu = [];

  // function getUserBlock(name){
  //   return db.utilisateurs.find(u => u.nom === name);
  // }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  }

  async function getUserName(id){
    const { data: user, error: e1 } = await supabase
      .from("users")
      .select("id, username")
      .eq("id", id)
      .single();

    if (e1) { console.error(e1); return; }

    return user.username;
  }

  // Load database
  async function loadDb(){


    // const { data: users, error: e1 } = await supabase
    //   .from("users")
    //   .select("id, username")
    //   .eq("id", id)
    //   .single();
    // if (e1) { console.error(e1); return; }

    // const SUPABASE_URL = sessionStorage.getItem("SUPABASE_URL");
    // const SUPABASE_ANON_KEY = sessionStorage.getItem("SUPABASE_ANON_KEY");
    // console.log(SUPABASE_URL)
    // console.log(SUPABASE_ANON_KEY)
  
    // db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


    // const fromStorage = localStorage.getItem(STORAGE_KEY);
    // if (fromStorage){
    //   db = JSON.parse(fromStorage);
    //   return;
    // }

    // const res = await fetch("cadeaux.json");
    // db = await res.json();



    // const { data: meUser, error: e1 } = await supabase
    //   .from("gifts")
    //   .select("id, username")
    //   .eq("username", me)
    //   .single();

    // if (e1) { console.error(e1); menu = [me]; return; }

    // // get who I can see
    // const { data: vis, error: e2 } = await supabase
    //   .from("user_visibility")
    //   .select("visible_username")
    //   .eq("viewer_id", meUser.id);

    // if (e2) { console.error(e2); menu = [me]; return; }

    // menu = vis.map(v => v.visible_username).sort((a,b) => a.localeCompare(b,"fr"));



    // save();
  }

  async function loadMenu(){

    const { data: vis, error: dbError } = await db
      .from("user_visibility")
      .select("visible_user_id")
      .eq("viewer_id", user_id);
    if (dbError) { console.error(dbError); return; }

    menu = vis.map(v => v.visible_user_id).sort((a,b) => a.localeCompare(b,"fr"));
  }

  // -------- Nav
  function buildNav(container, isMobile){
    container.innerHTML = "";
    menu.forEach(name => {
      const a = document.createElement("a");
      a.href = "#";
      a.className = (name === selectedUser) ? "active" : "";
      a.innerHTML = `<span>${name}</span>${name===me ? '<span class="meTag">moi</span>' : ""}`;

      a.addEventListener("click", (e) => {
        e.preventDefault();
        selectedUser = name;
        render();
        if (isMobile) closeMenu();
      });

      container.appendChild(a);
    });
  }

  async function getGiftSelectors(gift_id){

    const { data: gift_selection, error: error } = await db
      .from("gift_selection")
      .select("selector_id")
      .eq("gift_id", gift.id);

    if (error) {
      console.error("Failed to update gift status:", error);
      return;
    }

    const selectionne_par = gift_selection.map(o => o.selector_id);
    console.log(selectionne_par);

    const hasMe = selectionne_par.includes(user_id);

    retun (selectionne_par, hasMe);
  }


  // -------- Rendu liste cadeaux
  async function render(){

    buildNav(document.getElementById("desktopNav"), false);
    buildNav(document.getElementById("mobileNav"), true);

    const isMeMenu = (selectedUser === me);

    let query = db
      .from("gifts")
      .select("id, title, status, owner_id, author_id")
      .eq("owner_id", user_id);

    if (isMeMenu) {
      query = query.eq("author_id", user_id);
    }

    const { data: gifts, error: e1 } = await query;
    if (e1) { console.error(e1); return; }

    // // Filtrage pour la personne loggée: n'afficher que auteur = moi
    // const gifts = (block?.cadeaux || []).filter(g => !isMeMenu || g.auteur === me);

    // const block = getUserBlock(selectedUser);
    const list = document.getElementById("giftList");
    list.innerHTML = "";

    if (gifts.length === 0){
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `<div class="title" style="color:var(--muted);">Aucun cadeau à afficher.</div>`;
      list.appendChild(empty);
    }

    gifts.forEach(gift => {

      const (selectionne_par, hasMe) = await getGiftSelectors(gift.id);

      // const { data: gift_selection, error: e2 } = await db
      //   .from("gift_selection")
      //   .select("selector_id")
      //   .eq("gift_id", gift.id);
      // if (e2) { console.error(e2); return; }

      // const selectionne_par = gift_selection
      //   .map(o => o.selector_id);
      // console.log(selectionne_par);

      // const hasMe = selectionne_par.includes(user_id);

      const canDelete = (isMeMenu || ((gift.author_id === me) && ((selectionne_par.length === 0) || ((selectionne_par.length === 1) && hasMe))));


      const row = document.createElement("div");
      row.className = "item";

      const left = document.createElement("div");
      left.className = "left";

      const stateBtn = document.createElement("i");
      if (!isMeMenu){
        switch(gift.status) {
          case "deselectionne":
            stateBtn.className = "stateBtn fa-regular fa-square green";
            stateBtn.addEventListener("click", () => toggleStateForGift(selectedUser, gift.id));
            stateBtn.title = "";
            break;
          case "selectionne":
            if (hasMe) {
              stateBtn.className = "stateBtn fa-solid fa-gift red";
              stateBtn.addEventListener("click", () => toggleStateForGift(selectedUser, gift.id));
            } else {
              stateBtn.className = "stateBtn fa-solid fa-gift disabled";
            }
            stateBtn.title = "";
            break;
          default:
            if (hasMe) {
              stateBtn.className = "stateBtn fa-solid fa-cubes-stacked red";
              stateBtn.title = "Sélectionné par : " + selectionne_par.join(", ");
            } else {
              stateBtn.className = "stateBtn fa-solid fa-cubes-stacked green";
            }
            stateBtn.addEventListener("click", () => toggleStateForGift(selectedUser, gift.id));
        }
      } else {
        stateBtn.className = "stateBtn fa-solid fa-minus red";
      }

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = gift.titre;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = "Sélectionné par : " + selectionne_par.join(", ");

      const labelWrap = document.createElement("div");
      labelWrap.style.minWidth = "0";
      labelWrap.appendChild(title);
      if (gift.status === "selectionne_par_plusieurs" && !isMeMenu) {
        labelWrap.appendChild(meta);
      }

      left.appendChild(stateBtn);
      left.appendChild(labelWrap);

      const right = document.createElement("div");

      const delBtn = document.createElement("i");
      delBtn.className = "delBtn fa-solid fa-trash" + (!canDelete ? " disabled" : "");
      delBtn.title = canDelete ? "Supprimer ce cadeau" : "Impossible (sélectionné ou pas auteur)";
      if (canDelete) {
        delBtn.addEventListener("click", () => deleteGift(selectedUser, gift.id));
      }

      right.appendChild(delBtn);

      row.appendChild(left);
      row.appendChild(right);
      list.appendChild(row);


      document.getElementById("signature").textContent = selectedUser;
    });

    // Ajout cadeau
    const input = document.getElementById("giftInput");
    input.value = "";
    input.placeholder = `Ajouter un cadeau pour ${selectedUser}...`;

    const addBtn = document.getElementById("addBtn");
    addBtn.onclick = () => addGift(selectedUser, input.value.trim(), me);
    input.onkeydown = (e) => {
      if (e.key === "Enter") addGift(selectedUser, input.value.trim(), me);
    };
  }

  async function getGiftStatus(gift_id, newStatus) {
    const { gift, error } = await db
      .from("gifts")
      .select("status")
      .eq("id", giftId)
      .single();

    if (error) {
      console.error("Failed to get gift status:", error);
      return;
    }

    return gift.status;
  }

  async function setGiftStatus(gift_id) {
    const { error } = await db
      .from("gifts")
      .update({ status: newStatus })
      .eq("id", giftId);

    if (error) {
      console.error("Failed to update gift status:", error);
      return;
    }
  }

  async function addGiftSelector(gift_id, selector_id) {
    const { error } = await db
      .from("gift_selections")
      .upsert({ gift_id: gift_id, selector_id: selector_id });


    if (error) {
      console.error("Failed to add gift selector:", error);
      return;
    }
  }

  async function removeGiftSelector(gift_id, selector_id) {
    const { error } = await db
      .from("gift_selections")
      .delete()
      .eq("gift_id", gift_id)
      .eq("selector_id", selector_idd);

    if (error) {
      console.error("Failed to remove gift selector:", error);
      return;
    }
  }

  // async function removeAllGiftSelector(gift_id) {
  //   const { error } = await db
  //     .from("gift_selections")
  //     .delete()
  //     .eq("gift_id", gift_id)
  //     .eq("selector_id", selector_idd);

  //   if (error) {
  //     console.error("Failed to remove gift selector:", error);
  //     return;
  //   }
  // }

  // -------- Logique clic (cycle / contraintes)
  function toggleStateForGift(gift_id){

    // const block = getUserBlock(ownerName);
    // if (!block) return;

    // const gift = block.cadeaux.find(g => g.id === giftId);
    // if (!gift) return;

    // const { data: gift, error: e2 } = await db
    //   .from("gifts")
    //   .select("id, status")
    //   .eq("id", gift_id)
    //   .single();
    // if (e1) { console.error(e1); return; }

    // const { data: gift_selection, error: e2 } = await db
    //   .from("gift_selection")
    //   .select("selector_id")
    //   .eq("gift_id", gift.id);
    // if (e2) { console.error(e2); return; }

    // const selectionne_par = gift_selection
    //   .map(o => o.selector_id);
    // console.log(selectionne_par);

    const status = getGiftStatus(gift_id);
    const (selectionne_par, hasMe) = await getGiftSelectors(gift.id);

    switch(gift.status) {

      case "deselectionne":
        addGiftSelector(gift_id, user_id);
        setGiftStatus(gift_id, "selectionne");
        break;

      case "selectionne":
        setGiftStatus(gift_id, "selectionne_par_plusieurs");
        break;

      default:
        if (selectionne_par.length === 1 && hasMe){
          removeGiftSelector(gift_id, user_id);
          setGiftStatus(gift_id, "deselectionne");
        }
        if (selectionne_par.length > 1 && hasMe){
          removeGiftSelector(gift_id, user_id);
        }
        if (!hasMe){
          addGiftSelector(gift_id, user_id);
        }
    }

    // save();
    render();
  }

  function addGift(ownerName, title, author){
    if (!title) return;

    const block = getUserBlock(ownerName);
    if (!block) return;

    // auteur = propriétaire de la liste
    const newGift = {
      id: `${ownerName.toLowerCase()}-${Date.now()}`,
      titre: title,
      auteur: author,
      etat: "deselectionne",
      selectionne_par: []
    };

    block.cadeaux = block.cadeaux || [];
    block.cadeaux.push(newGift);

    save();
    render();
  }

  function deleteGift(ownerName, giftId){
    const block = getUserBlock(ownerName);
    if (!block) return;

    const idx = block.cadeaux.findIndex(g => g.id === giftId);
    if (idx === -1) return;

    const g = block.cadeaux[idx];

    block.cadeaux.splice(idx, 1);
    save();
    render();
  }

  // -------- Menu mobile
  function openMenu(){
    document.getElementById("overlay").classList.add("show");
    document.getElementById("drawer").classList.add("open");
  }

  function closeMenu(){
    document.getElementById("overlay").classList.remove("show");
    document.getElementById("drawer").classList.remove("open");
  }

  function openHelp(){
    document.getElementById("helpModal").classList.add("show");
  }

  function closeHelp(){
    document.getElementById("helpModal").classList.remove("show");
  }

  function logout(){
    sessionStorage.clear();
    window.location.href = "index.html";
  }

  // -------- Init
  (async function init(){

    // await loadDB();
    await loadMenu();

    selectedUser = menu.includes(user_id) ? user_id : menu[0];

    await render();
  })();
</script>

</body>
</html>
