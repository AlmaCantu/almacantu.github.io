<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rochester&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


  
  <title>Dashboard</title>

  <style>
    :root{
      --pine-900: #0b3d2e;   /* very dark pine */
      --pine-800: #0f5132;   /* dark pine */
      --pine-700: #146c43;   /* hover */
      --pine-text: #e9f5ef;  /* light text */
      --pine-line: #083628;
      /* --my-icon-btn: #4E79A7; */
      --gift: #E15759;
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: "Rochester", cursive;
      color: var(--text);
      background-image: url("background.jpg");
      background-size: cover;        /* fill screen */
      background-position: center;   /* center image */
      background-repeat: no-repeat;  /* no tiling */
      background-attachment: fixed;  /* optional: parallax effect */
    }

    /* Header */
    .topbar{
      position: sticky; top:0; z-index: 10;
      display:flex; align-items:center; justify-content: space-between;
      padding: 12px 16px; background: var(--pine-900);
      color: var(--pine-text);
    }
    
    .topbar .brand,
    .topbar .sub {
      color: var(--pine-text);
    }
    
    .brand{ display:flex; align-items:center; gap:10px; font-weight:700; }
    
    .sub{ font-weight: normal; font-size: 12px; color: var(--muted); }
    
    .menu-btn{
      display:none; border:1px solid var(--line); background:#fff;
      padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    
    .btn{
      border:1px solid var(--line); background:#fff;
      padding:8px 12px; border-radius:10px; cursor:pointer;
    }

    /* Layout */
    .layout{ display:grid; grid-template-columns: 260px 1fr; min-height: calc(100vh - 60px); }

    /* Sidebar */
    .sidebar{ background: var(--pine-800); border-right: 1px solid var(--pine-line); padding: 14px; color: var(--pine-text)}
  
    .nav a{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px; margin-bottom:6px;
      border-radius: 10px; text-decoration:none; color: var(--pine-text);
    }
    
    .nav a:hover{ background: var(--pine-700); }
    
    .nav a.active{ background: var(--pine-900); }
    
    .meTag{
      font-size: 11px;
      padding: 2px 8px;
      border:1px solid var(--line);
      border-radius: 999px;
      color: var(--muted);
      background:#fff;
    }

    /* Main */
    main{ display:flex; justify-content:center; padding: 24px 16px; }
    
    .panel{
      width: 70%;
      max-width: 980px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
    }
    
    h1{ margin:0 0 6px; font-size: 20px; }
    
    .hint{ margin:0 0 14px; color: var(--muted); line-height: 1.6; font-size: 14px; }

    /* Gift list */
    .list{
      border-top: 1px solid var(--line);
      margin-top: 12px;
      padding-top: 12px;
    }
    
    .item{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 8px;
      border-radius: 12px;
    }
    
    .item:hover{ background:#f8fafc; }
    .left{
      display:flex; align-items:center; gap: 10px; min-width: 0;
    }
    
    .title{
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .meta{
      font-size: 12px;
      color: var(--muted);
      margin-left: 8px;
    }

    .stateBtn{
      font-size: 16px;
      cursor: pointer;
      user-select: none;
      color: var(--gift);
      opacity: .85;
    }

    .stateBtn:hover{
      opacity: 1;
    }
    
    .stateBtn.disabled{
      color: #b3b3b3;
      opacity: .85;
      cursor: not-allowed;
    }

    .delBtn{
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      color: #991b1b;
      opacity: .85;
    }
    
    .delBtn:hover{
      opacity: 1;
    }
    
    .delBtn.disabled{
      color: #b3b3b3;
      opacity: .85;
      cursor: not-allowed;
    }

    /* Add gift row */
    .addRow{
      display:flex;
      gap: 10px;
      align-items:center;
      padding: 12px 8px;
      border-top: 1px dashed var(--line);
      margin-top: 10px;
    }
    .plusBtn{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-size: 18px;
      line-height: 1;
    }
    .giftInput{
      flex: 1;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }

    /* Mobile */
    @media (max-width: 900px){
      .layout{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
      .menu-btn{ display:inline-block; }
      .panel{ width: 100%; }
    }

    /* Mobile drawer */
    .overlay{ position: fixed; inset:0; background: rgba(0,0,0,.35); display:none; z-index:20; }
    .overlay.show{ display:block; }
    .drawer{
      position: fixed; top:0; left:-280px; width:260px; height:100%;
      background: var(--pine-900);
      /* border-right: 1px solid var(--line); */
      padding:14px; transition:left .2s ease; z-index:30;
      box-shadow: var(--shadow);
      color: var(--pine-text);
    }
    .drawer.open{ left:0; }
  </style>
</head>
<body>

<script>
  // Guard (démo)
  if (sessionStorage.getItem("loggedIn") !== "true") {
    window.location.href = "index.html";
  }
</script>

<header class="topbar">
  <div>
    <div class="brand">
      <button class="menu-btn" onclick="openMenu()">☰</button>
      Lettre au Père Noël
    </div>
    <!-- <div class="sub" id="subline"></div> -->
  </div>
  <button class="btn" onclick="logout()">Logout</button>
</header>

<div class="layout">
  <!-- Desktop sidebar -->
  <aside class="sidebar">
    <!-- <div class="nav-title">Utilisateurs</div> -->
    <nav class="nav" id="desktopNav"></nav>
  </aside>

  <!-- Main content -->
  <main>
    <section class="panel">
      <!-- <h1 id="title"></h1>
      <p class="hint" id="hint"></p> -->

      <p>
        Cher Père Noël,
      </p>
    
      <p>
        J’espère que tu vas bien avec tous les cadeaux à préparer.
        Cette année, j’ai essayé d’être sage et de faire de mon mieux.
      </p>
    
      <p>
        Pour Noël, j’aimerais beaucoup recevoir les quelques cadeaux suivants :
      </p>

      <div class="list" id="giftList"></div>

      <div class="addRow">
        <button class="plusBtn" id="addBtn" title="Ajouter un cadeau">+</button>
        <input class="giftInput" id="giftInput" placeholder="Ajouter un cadeau..." />
      </div>

      <p>
        Merci pour tout le travail que tu fais chaque année.
      </p>
    
      <p>
        Mille bisous,
      </p>
    
      <p id="signature"></p>
      
    </section>
  </main>
</div>

<!-- Mobile drawer -->
<div class="overlay" id="overlay" onclick="closeMenu()"></div>
<aside class="drawer" id="drawer">
  <nav class="nav" id="mobileNav"></nav>
</aside>

<script>
  // -------- Config menus (ordre choisi)
  const MENU = ["Alma","Anna","Antoine","Coline","Gabin","Guillaume","Lise"];
  const STORAGE_KEY = "cadeauxData_v1";

  // Utilisateur connecté
  const me = sessionStorage.getItem("username") || "User";
  let selectedUser = MENU.includes(me) ? me : MENU[0];

  // Données
  let db = null;

  // -------- Helpers état
  // function normalizeEtat(selectionne_par){
  //   if (!selectionne_par || selectionne_par.length === 0) return "deselectionne";
  //   if (selectionne_par.length === 1) return "selectionne";
  //   return "selectionne_par_plusieurs";
  // }

  function stateIcon(etat){
    if (etat === "selectionne") return "fa-solid fa-gift";
    if (etat === "selectionne_par_plusieurs") return "fa-solid fa-grip-vertical";
    return "fa-regular fa-square";
  }

  function getUserBlock(name){
    return db.utilisateurs.find(u => u.nom === name);
  }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  }

  async function loadDB(){
    const fromStorage = localStorage.getItem(STORAGE_KEY);
    if (fromStorage){
      db = JSON.parse(fromStorage);
      return;
    }
    const res = await fetch("cadeaux.json");
    db = await res.json();
    // normalise les états au chargement (au cas où)
    // db.utilisateurs.forEach(u => {
    //   u.cadeaux.forEach(g => {
    //     g.selectionne_par = g.selectionne_par || [];
    //     g.etat = normalizeEtat(g.selectionne_par);
    //   });
    // });
    save();
  }

  // -------- Nav
  function buildNav(container, isMobile){
    container.innerHTML = "";
    MENU.forEach(name => {
      const a = document.createElement("a");
      a.href = "#";
      a.className = (name === selectedUser) ? "active" : "";
      a.innerHTML = `<span>${name}</span>${name===me ? '<span class="meTag">moi</span>' : ""}`;

      a.addEventListener("click", (e) => {
        e.preventDefault();
        selectedUser = name;
        render();
        if (isMobile) closeMenu();
      });

      container.appendChild(a);
    });
  }

  // -------- Rendu liste cadeaux
  function render(){
    buildNav(document.getElementById("desktopNav"), false);
    buildNav(document.getElementById("mobileNav"), true);

    const isMeMenu = (selectedUser === me);
    // document.getElementById("title").textContent = `Cadeaux — ${selectedUser}`;
    // document.getElementById("hint").textContent = isMeMenu
    //   ? "Ici tu vois uniquement les cadeaux dont tu es l’auteur. Tu peux ajouter et supprimer (si non sélectionné)."
    //   : "Clique sur l’icône pour changer l’état (démo). Survol = personnes qui ont sélectionné.";

    document.getElementById("signature").textContent = selectedUser;

    const block = getUserBlock(selectedUser);
    const list = document.getElementById("giftList");
    list.innerHTML = "";

    // Filtrage pour la personne loggée: n'afficher que auteur = moi
    const gifts = (block?.cadeaux || []).filter(g => !isMeMenu || g.auteur === me);

    if (gifts.length === 0){
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `<div class="title" style="color:var(--muted);">Aucun cadeau à afficher.</div>`;
      list.appendChild(empty);
    }

    gifts.forEach(gift => {
      // gift.selectionne_par = gift.selectionne_par || [];
      // gift.etat = normalizeEtat(gift.selectionne_par);

      const row = document.createElement("div");
      row.className = "item";

      const left = document.createElement("div");
      left.className = "left";

      // Bouton état uniquement pour les autres utilisateurs
      const stateBtn = document.createElement("i");
      stateBtn.className = "stateBtn " + stateIcon(gift.etat);

      const who = gift.selectionne_par.length ? gift.selectionne_par.join(", ") : "Personne";
      stateBtn.title = `Sélectionné par : ${who}`;

      // Règle: si l'utilisateur veut deselectionner mais que d'autres restent, interdit
      stateBtn.disabled = false;

      if (!isMeMenu){
        stateBtn.addEventListener("click", () => toggleStateForGift(selectedUser, gift.id));
      }

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = gift.titre;

      const labelWrap = document.createElement("div");
      labelWrap.style.minWidth = "0";
      labelWrap.appendChild(title);
      if (!isMeMenu){
        left.appendChild(stateBtn);
      }
      left.appendChild(labelWrap);

      const right = document.createElement("div");

      // Supprimer: seulement si je suis auteur + pas sélectionné
      const canDelete = isMeMenu || ((gift.auteur === me) && ((gift.selectionne_par.length === 0) || (gift.selectionne_par === [me]));
      const delBtn = document.createElement("i");
      delBtn.className = "delBtn fa-solid fa-trash";
      if (!canDelete){
        delBtn.classList.add("disabled");
      }
      delBtn.title = canDelete ? "Supprimer ce cadeau" : "Impossible (sélectionné ou pas auteur)";

      delBtn.addEventListener("click", () => {
        if (!canDelete) return;
        deleteGift(selectedUser, gift.id);
      });

      right.appendChild(delBtn);

      row.appendChild(left);
      row.appendChild(right);
      list.appendChild(row);
    });

    // Ajout cadeau
    const input = document.getElementById("giftInput");
    input.value = "";
    input.placeholder = `Ajouter un cadeau pour ${selectedUser}...`;

    const addBtn = document.getElementById("addBtn");
    addBtn.onclick = () => addGift(selectedUser, input.value.trim());
    input.onkeydown = (e) => {
      if (e.key === "Enter") addGift(selectedUser, input.value.trim());
    };
  }

  // -------- Logique clic (cycle / contraintes)
  function toggleStateForGift(ownerName, giftId){
    const block = getUserBlock(ownerName);
    if (!block) return;

    const gift = block.cadeaux.find(g => g.id === giftId);
    if (!gift) return;

    gift.selectionne_par = gift.selectionne_par || [];
    gift.etat = normalizeEtat(gift.selectionne_par);

    const hasMe = gift.selectionne_par.includes(me);

    // Cycle demandé (démo) :
    // deselectionne -> selectionne -> selectionne_par_plusieurs -> deselectionne
    // avec contrainte : si d'autres ont sélectionné, on ne peut pas désélectionner (si ça enlève les autres)
    if (gift.etat === "deselectionne"){
      gift.selectionne_par = [me];
    } else if (gift.etat === "selectionne"){
      // si c'est moi seul, on passe en "plusieurs" (ajout d'un second sélecteur démo)
      if (gift.selectionne_par.length === 1 && hasMe){
        gift.selectionne_par = [me, "Quelqu'un d'autre"];
      } else {
        // sinon on tente deselectionner (mais si d'autres restent => bloqué)
        // (cas rare si JSON initial contient autre personne)
        if (gift.selectionne_par.length > 1 && hasMe){
          alert("Impossible de désélectionner : d'autres personnes l'ont sélectionné.");
          return;
        }
        gift.selectionne_par = [];
      }
    } else { // selectionne_par_plusieurs
      // tenter de deselectionner
      const others = gift.selectionne_par.filter(x => x !== me);
      if (others.length > 0){
        // si d'autres restent, pas le droit
        alert("Impossible de désélectionner : d'autres personnes l'ont sélectionné.");
        return;
      }
      gift.selectionne_par = [];
    }

    gift.etat = normalizeEtat(gift.selectionne_par);
    save();
    render();
  }

  function addGift(ownerName, title){
    if (!title) return;

    const block = getUserBlock(ownerName);
    if (!block) return;

    // auteur = propriétaire de la liste
    const newGift = {
      id: `${ownerName.toLowerCase()}-${Date.now()}`,
      titre: title,
      auteur: ownerName,
      etat: "deselectionne",
      selectionne_par: []
    };

    block.cadeaux = block.cadeaux || [];
    block.cadeaux.push(newGift);

    save();
    render();
  }

  function deleteGift(ownerName, giftId){
    const block = getUserBlock(ownerName);
    if (!block) return;

    const idx = block.cadeaux.findIndex(g => g.id === giftId);
    if (idx === -1) return;

    const g = block.cadeaux[idx];
    if (g.auteur !== me) return;
    if ((g.selectionne_par || []).length > 0) return;

    block.cadeaux.splice(idx, 1);
    save();
    render();
  }

  // -------- Menu mobile
  function openMenu(){
    document.getElementById("overlay").classList.add("show");
    document.getElementById("drawer").classList.add("open");
  }
  function closeMenu(){
    document.getElementById("overlay").classList.remove("show");
    document.getElementById("drawer").classList.remove("open");
  }

  function logout(){
    sessionStorage.clear();
    window.location.href = "index.html";
  }

  // -------- Init
  (async function init(){
    await loadDB();

    // Si l'utilisateur connecté n'existe pas dans cadeaux.json, on laisse le menu par défaut
    if (!getUserBlock(selectedUser)) selectedUser = MENU[0];

    render();
  })();
</script>

</body>
</html>
