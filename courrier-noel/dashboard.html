<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Borel&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="style.css">

  <title>Dashboard</title>
</head>
<body>

<script>
  // Guard (démo)
  if (sessionStorage.getItem("loggedIn") !== "true") {
    window.location.href = "index.html";
  }
</script>

<header class="topbar">
  <div>
    <div class="brand">
      <button class="menu-btn" onclick="openMenu()">☰</button>
      Lettre au Père Noël
    </div>
  </div>
  <div class="header-actions">
    <button class="btn" onclick="openHelp()"><i class="fa-regular fa-circle-question"></i></button>
    <button class="btn" onclick="logout()"><i class="fa-solid fa-arrow-right-from-bracket"></i></button>
  </div>
</header>

<div class="layout">
  <!-- Desktop sidebar -->
  <aside class="sidebar">
    <!-- <div class="nav-title">Utilisateurs</div> -->
    <nav class="nav" id="desktopNav"></nav>
  </aside>

  <!-- Main content -->
  <main>
    <section class="panel">
      <!-- <h1 id="title"></h1>
      <p class="hint" id="hint"></p> -->
      <div class="letter-body">
        <p>
          Cher Père Noël,
        </p>
      
        <p>
          J’espère que tu vas bien avec tous les cadeaux à préparer.
          Cette année, j’ai essayé d’être sage et de faire de mon mieux.
        </p>
      
        <p>
          Pour Noël, j’aimerais beaucoup recevoir les quelques cadeaux suivants :
        </p>
  
        <div class="list" id="giftList"></div>
  
        <div class="addRow">
          <button class="plusBtn" id="addBtn" title="Ajouter un cadeau">+</button>
          <input class="giftInput" id="giftInput" placeholder="Ajouter un cadeau..." />
        </div>
      </div>

      <div class="letter-footer">
        <p>
          Merci pour tout le travail que tu fais chaque année.
        </p>
      
        <p>
          Mille bisous,
        </p>
      
        <p id="signature"></p>
      </div>
      
    </section>
  </main>
</div>

<!-- Mobile drawer -->
<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<aside class="drawer" id="drawer">
  <nav class="nav" id="mobileNav"></nav>
</aside>

<!-- Help popup -->
<div class="modal-overlay" id="helpModal" onclick="closeHelp()">
  <div class="modal" onclick="event.stopPropagation()">
    <h2>Instructions</h2>

    <p>
      <!-- This page is a demo dashboard. Use the menu to navigate and read the content -->
      <!-- inside the letter panel. -->
    </p>

    <div>
      <p><i class="stateBtn fa-regular fa-square green"></i>&nbsp;Idée de cadeau disponible</p>
      <p><i class="stateBtn fa-solid fa-gift red"></i>&nbsp;Cadeau sélectionné par toi</p>
      <p><i class="stateBtn fa-solid fa-gift disabled"></i>&nbsp;Cadeau sélectionné par une autre personne</p>
      <p><i class="stateBtn fa-solid fa-cubes-stacked green"></i>&nbsp;Cadeau sélectionné par d'autres mais ouvert au partage</p>
      <p><i class="stateBtn fa-solid fa-cubes-stacked red"></i>&nbsp;Cadeau sélectionné par toi et ouvert au partage</p>
    </div>

    <button class="btn" onclick="closeHelp()">x</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

  // Storage key
  const STORAGE_KEY = "cadeauxData_v1";

  // Données
  const SUPABASE_URL = sessionStorage.getItem("SUPABASE_URL");
  const SUPABASE_ANON_KEY = sessionStorage.getItem("SUPABASE_ANON_KEY");
  const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Utilisateur connecté
  const user_id = sessionStorage.getItem("user_id");
  // console.log(user_id);
  let selectedUser = "";

  // Menu
  let menu = [];

  // function getUserBlock(name){
  //   return db.utilisateurs.find(u => u.nom === name);
  // }

  // function save(){
  //   localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  // }

  async function loadMenu(){

    const { data: vis, error: dbError } = await db
      .from("user_visibility")
      .select("visible_user_id")
      .eq("viewer_id", user_id);
    if (dbError) { console.error(dbError); return; }

    menu = vis.map(v => v.visible_user_id).sort((a,b) => a.localeCompare(b,"fr"));
  }

  // -------- Nav
  function buildNav(container, isMobile){
    container.innerHTML = "";
    menu.forEach(name => {
      const a = document.createElement("a");
      a.href = "#";
      a.className = (name === selectedUser) ? "active" : "";
      a.innerHTML = `<span>${name}</span>${name===user_id ? '<span class="meTag">moi</span>' : ""}`;

      a.addEventListener("click", (e) => {
        e.preventDefault();
        selectedUser = name;
        render();
        if (isMobile) closeMenu();
      });

      container.appendChild(a);
    });
  }

  async function getGiftSelectors(gift_id){

    const { data: gift_selection, error: error } = await db
      .from("gift_selections")
      .select("selector_id")
      .eq("gift_id", gift_id);

    if (error) {
      console.error("Failed to get gift selectors:", error);
      return;
    }

    const selectionne_par = gift_selection.map(o => o.selector_id);
    const hasMe = selectionne_par.includes(user_id);

    return {selectionne_par, hasMe};
  }


  // -------- Rendu liste cadeaux
  async function render(){

    buildNav(document.getElementById("desktopNav"), false);
    buildNav(document.getElementById("mobileNav"), true);

    const isMeMenu = (selectedUser === user_id);

    let query = db
      .from("gifts")
      .select("id, title, status, owner_id, author_id")
      .eq("owner_id", selectedUser)
      .order("created_at", { ascending: true });

    if (isMeMenu) {
      query = query.eq("author_id", user_id);
    }

    const { data: gifts, error: error } = await query;

    if (error) {
      console.error("Failed to get gifts:", error);
      return;
    }

    // // Filtrage pour la personne loggée: n'afficher que auteur = moi
    // const gifts = (block?.cadeaux || []).filter(g => !isMeMenu || g.auteur === me);

    // const block = getUserBlock(selectedUser);
    const list = document.getElementById("giftList");
    list.innerHTML = "";

    if (gifts.length === 0){
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `<div class="title" style="color:var(--muted);">Aucun cadeau à afficher.</div>`;
      list.appendChild(empty);
    }

    gifts.forEach(async gift => {

      const {selectionne_par, hasMe} = await getGiftSelectors(gift.id);

      const canDelete = (isMeMenu || ((gift.author_id === user_id) && ((selectionne_par.length === 0) || ((selectionne_par.length === 1) && hasMe))));

      const row = document.createElement("div");
      row.className = "item";

      const left = document.createElement("div");
      left.className = "left";

      const stateBtn = document.createElement("i");
      if (!isMeMenu){
        switch(gift.status) {
          case "deselectionne":
            stateBtn.className = "stateBtn fa-regular fa-square green";
            stateBtn.addEventListener("click", async () => toggleStateForGift(gift.id));
            stateBtn.title = "";
            break;
          case "selectionne":
            if (hasMe) {
              stateBtn.className = "stateBtn fa-solid fa-gift red";
              stateBtn.addEventListener("click", async () => toggleStateForGift(gift.id));
            } else {
              stateBtn.className = "stateBtn fa-solid fa-gift disabled";
            }
            stateBtn.title = "";
            break;
          default:
            if (hasMe) {
              stateBtn.className = "stateBtn fa-solid fa-cubes-stacked red";
              stateBtn.title = "Sélectionné par : " + selectionne_par.join(", ");
            } else {
              stateBtn.className = "stateBtn fa-solid fa-cubes-stacked green";
            }
            stateBtn.addEventListener("click", async () => toggleStateForGift(gift.id));
        }
      } else {
        stateBtn.className = "stateBtn fa-solid fa-minus red";
      }

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = gift.title;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = "Sélectionné par : " + selectionne_par.join(", ");

      const labelWrap = document.createElement("div");
      labelWrap.style.minWidth = "0";
      labelWrap.appendChild(title);
      if (gift.status === "selectionne_par_plusieurs" && !isMeMenu) {
        labelWrap.appendChild(meta);
      }

      left.appendChild(stateBtn);
      left.appendChild(labelWrap);

      const right = document.createElement("div");

      const delBtn = document.createElement("i");
      delBtn.className = "delBtn fa-solid fa-trash" + (!canDelete ? " disabled" : "");
      delBtn.title = canDelete ? "Supprimer ce cadeau" : "Impossible (sélectionné ou pas auteur)";
      if (canDelete) {
        delBtn.addEventListener("click", async () => deleteGift(gift.id));
      }

      right.appendChild(delBtn);

      row.appendChild(left);
      row.appendChild(right);
      list.appendChild(row);

      document.getElementById("signature").textContent = selectedUser;
    });

    // Ajout cadeau
    const input = document.getElementById("giftInput");
    input.value = "";
    input.placeholder = "Ajouter un cadeau pour ${selectedUser}...";

    const addBtn = document.getElementById("addBtn");
    addBtn.onclick = async () => addGift(selectedUser, input.value.trim(), user_id);
    input.onkeydown = async (e) => {
      if (e.key === "Enter") await addGift(selectedUser, input.value.trim(), user_id);
    };
  }

  async function getGiftStatus(gift_id) {

    console.log(gift_id);

    const { gift, error } = await db
      .from("gifts")
      .select("status")
      .eq("id", gift_id);

    if (error) {
      console.error("Failed to get gift status:", error);
      return;
    }

    console.log(gift);

    return gift.status;
  }

  async function setGiftStatus(gift_id, newStatus) {
    const { error } = await db
      .from("gifts")
      .update({ status: newStatus })
      .eq("id", giftId);

    if (error) {
      console.error("Failed to update gift status:", error);
      return;
    }
  }

  async function addGiftSelector(gift_id, selector_id) {
    const { error } = await db
      .from("gift_selections")
      .upsert({ gift_id: gift_id, selector_id: selector_id });


    if (error) {
      console.error("Failed to add gift selector:", error);
      return;
    }
  }

  async function removeGiftSelector(gift_id, selector_id) {
    const { error } = await db
      .from("gift_selections")
      .delete()
      .eq("gift_id", gift_id)
      .eq("selector_id", selector_id);

    if (error) {
      console.error("Failed to remove gift selector:", error);
      return;
    }
  }

  async function toggleStateForGift(gift_id){

    const status = await getGiftStatus(gift_id);
    const {selectionne_par, hasMe} = await getGiftSelectors(gift.id);

    switch(status) {

      case "deselectionne":
        await addGiftSelector(gift_id, user_id);
        await setGiftStatus(gift_id, "selectionne");
        break;

      case "selectionne":
        await setGiftStatus(gift_id, "selectionne_par_plusieurs");
        break;

      default:
        if (selectionne_par.length === 1 && hasMe){
          await removeGiftSelector(gift_id, user_id);
          await setGiftStatus(gift_id, "deselectionne");
        }
        if (selectionne_par.length > 1 && hasMe){
          await removeGiftSelector(gift_id, user_id);
        }
        if (!hasMe){
          await addGiftSelector(gift_id, user_id);
        }
    }

    // save();
    await render();
  }

  async function addGift(owner_id, title, author_id){

    const { error } = await db
      .from("gifts")
      .insert({
        title: title,
        status: "deselectionne",
        owner_id: owner_id,
        author_id: author_id
      })
      .select("id")
      .single();

    if (error) {
      console.error("Failed to add a gift:", error);
      return;
    }



    // if (!title) return;

    // const block = getUserBlock(ownerName);
    // if (!block) return;

    // // auteur = propriétaire de la liste
    // const newGift = {
    //   id: `${ownerName.toLowerCase()}-${Date.now()}`,
    //   titre: title,
    //   auteur: author,
    //   etat: "deselectionne",
    //   selectionne_par: []
    // };

    // block.cadeaux = block.cadeaux || [];
    // block.cadeaux.push(newGift);

    // save();
    await render();
  }

  async function deleteGift(gift_id){
    // const block = getUserBlock(ownerName);
    // if (!block) return;

    // const idx = block.cadeaux.findIndex(g => g.id === giftId);
    // if (idx === -1) return;

    // const g = block.cadeaux[idx];

    // block.cadeaux.splice(idx, 1);
    // save();
    // render();



    const { e1 } = await db
      .from("gifts")
      .delete()
      .eq("id", gift_id);

    if (e1) {
      console.error("Failed to remove a gift:", e1);
      return;
    }

    const { e2 } = await db
      .from("gift_selections")
      .delete()
      .eq("gift_id", gift_id);

    if (e2) {
      console.error("Failed to remove gift selections:", e2);
      return;
    }
  }

  // -------- Menu mobile
  function openMenu(){
    document.getElementById("overlay").classList.add("show");
    document.getElementById("drawer").classList.add("open");
  }

  function closeMenu(){
    document.getElementById("overlay").classList.remove("show");
    document.getElementById("drawer").classList.remove("open");
  }

  function openHelp(){
    document.getElementById("helpModal").classList.add("show");
  }

  function closeHelp(){
    document.getElementById("helpModal").classList.remove("show");
  }

  function logout(){
    sessionStorage.clear();
    window.location.href = "index.html";
  }

  // -------- Init
  (async function init(){

    // await loadDB();
    await loadMenu();

    selectedUser = menu.includes(user_id) ? user_id : menu[0];

    await render();
  })();

</script>

</body>
</html>
