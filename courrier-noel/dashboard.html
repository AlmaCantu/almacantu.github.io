<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Borel&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="style.css">

  <title>Dashboard</title>
</head>
<body>

<script>
  // Guard (démo)
  if (sessionStorage.getItem("loggedIn") !== "true") {
    window.location.href = "index.html";
  }
</script>

<header class="topbar">
  <div>
    <div class="brand">
      <button class="menu-btn" onclick="openMenu()">☰</button>
      Lettre au Père Noël
    </div>
  </div>
  <div class="header-actions">
    <button class="btn" onclick="openHelp()"><i class="fa-regular fa-circle-question"></i></button>
    <button class="btn" onclick="logout()"><i class="fa-solid fa-arrow-right-from-bracket"></i></button>
  </div>
</header>

<div class="layout">
  <!-- Desktop sidebar -->
  <aside class="sidebar">
    <!-- <div class="nav-title">Utilisateurs</div> -->
    <nav class="nav" id="desktopNav"></nav>
  </aside>

  <!-- Main content -->
  <main>
    <section class="panel">
      <!-- <h1 id="title"></h1>
      <p class="hint" id="hint"></p> -->
      <div class="letter-body">
        <p>
          Cher Père Noël,
        </p>
      
        <p>
          J’espère que tu vas bien avec tous les cadeaux à préparer.
          Cette année, j’ai essayé d’être sage et de faire de mon mieux.
        </p>
      
        <p>
          Pour Noël, j’aimerais beaucoup recevoir les quelques cadeaux suivants :
        </p>
  
        <div class="list" id="giftList"></div>
  
        <div class="addRow">
          <button class="plusBtn" id="addBtn" title="Ajouter un cadeau">+</button>
          <input class="giftInput" id="giftInput" placeholder="Ajouter un cadeau..." />
        </div>
      </div>

      <div class="letter-footer">
        <p>
          Merci pour tout le travail que tu fais chaque année.
        </p>
      
        <p>
          Mille bisous,
        </p>
      
        <p id="signature"></p>
      </div>
      
    </section>
  </main>
</div>

<!-- Mobile drawer -->
<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<aside class="drawer" id="drawer">
  <nav class="nav" id="mobileNav"></nav>
</aside>

<!-- Help popup -->
<div class="modal-overlay" id="helpModal" onclick="closeHelp()">
  <div class="modal" onclick="event.stopPropagation()">
    <h2>Instructions</h2>

    <p>
      <!-- This page is a demo dashboard. Use the menu to navigate and read the content -->
      <!-- inside the letter panel. -->
    </p>

    <div>
      <p><i class="stateBtn fa-regular fa-square green"></i>&nbsp;Idée de cadeau disponible</p>
      <p><i class="stateBtn fa-solid fa-gift red"></i>&nbsp;Cadeau sélectionné par toi</p>
      <p><i class="stateBtn fa-solid fa-gift disabled"></i>&nbsp;Cadeau sélectionné par une autre personne</p>
      <p><i class="stateBtn fa-solid fa-cubes-stacked green"></i>&nbsp;Cadeau sélectionné par d'autres mais ouvert au partage</p>
      <p><i class="stateBtn fa-solid fa-cubes-stacked red"></i>&nbsp;Cadeau sélectionné par toi et ouvert au partage</p>
    </div>

    <button class="btn" onclick="closeHelp()">x</button>
  </div>
</div>


<script>

  // -------- Config
  let menu = [];
  // const MENU = ["Alma","Anna","Antoine","Coline","Gabin","Guillaume","Lise"];
  const STORAGE_KEY = "cadeauxData_v1";

  // Utilisateur connecté
  const me = sessionStorage.getItem("username");
  let selectedUser = "";

  // Données
  let db = null;

  function getUserBlock(name){
    return db.utilisateurs.find(u => u.nom === name);
  }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  }

  async function loadMenu(){
    
    const res = await fetch("users.json");
    const usersDb = await res.json();

    const meBlock = usersDb.users.find(u => u.username === me);

    const all_users = (usersDb.users || [])
      .map(u => u.username)
      .filter(Boolean)
      .sort((a,b) => a.localeCompare(b, "fr"));

    menu = all_users.filter(name => 
      meBlock.visible.includes(name)
    );
  }

  async function loadDB(){
    const fromStorage = localStorage.getItem(STORAGE_KEY);
    if (fromStorage){
      db = JSON.parse(fromStorage);
      return;
    }

    const res = await fetch("cadeaux.json");
    db = await res.json();

    save();
  }

  // -------- Nav
  function buildNav(container, isMobile){
    container.innerHTML = "";
    menu.forEach(name => {
      const a = document.createElement("a");
      a.href = "#";
      a.className = (name === selectedUser) ? "active" : "";
      a.innerHTML = `<span>${name}</span>${name===me ? '<span class="meTag">moi</span>' : ""}`;

      a.addEventListener("click", (e) => {
        e.preventDefault();
        selectedUser = name;
        render();
        if (isMobile) closeMenu();
      });

      container.appendChild(a);
    });
  }

  // -------- Rendu liste cadeaux
  function render(){
    buildNav(document.getElementById("desktopNav"), false);
    buildNav(document.getElementById("mobileNav"), true);

    const isMeMenu = (selectedUser === me);
    // document.getElementById("title").textContent = `Cadeaux — ${selectedUser}`;
    // document.getElementById("hint").textContent = isMeMenu
    //   ? "Ici tu vois uniquement les cadeaux dont tu es l’auteur. Tu peux ajouter et supprimer (si non sélectionné)."
    //   : "Clique sur l’icône pour changer l’état (démo). Survol = personnes qui ont sélectionné.";

    document.getElementById("signature").textContent = selectedUser;

    const block = getUserBlock(selectedUser);
    const list = document.getElementById("giftList");
    list.innerHTML = "";

    // Filtrage pour la personne loggée: n'afficher que auteur = moi
    const gifts = (block?.cadeaux || []).filter(g => !isMeMenu || g.auteur === me);

    if (gifts.length === 0){
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `<div class="title" style="color:var(--muted);">Aucun cadeau à afficher.</div>`;
      list.appendChild(empty);
    }

    gifts.forEach(gift => {

      const hasMe = gift.selectionne_par.includes(me);
      const canDelete = (isMeMenu || ((gift.auteur === me) && ((gift.selectionne_par.length === 0) || ((gift.selectionne_par.length === 1) && hasMe))));


      const row = document.createElement("div");
      row.className = "item";

      const left = document.createElement("div");
      left.className = "left";

      const stateBtn = document.createElement("i");
      if (!isMeMenu){
        switch(gift.etat) {
          case "deselectionne":
            stateBtn.className = "stateBtn fa-regular fa-square green";
            stateBtn.addEventListener("click", () => toggleStateForGift(selectedUser, gift.id));
            stateBtn.title = "";
            break;
          case "selectionne":
            if (hasMe) {
              stateBtn.className = "stateBtn fa-solid fa-gift red";
              stateBtn.addEventListener("click", () => toggleStateForGift(selectedUser, gift.id));
            } else {
              stateBtn.className = "stateBtn fa-solid fa-gift disabled";
            }
            stateBtn.title = "";
            break;
          default:
            if (hasMe) {
              stateBtn.className = "stateBtn fa-solid fa-cubes-stacked red";
              stateBtn.title = "Sélectionné par : " + gift.selectionne_par.join(", ");
            } else {
              stateBtn.className = "stateBtn fa-solid fa-cubes-stacked green";
            }
            stateBtn.addEventListener("click", () => toggleStateForGift(selectedUser, gift.id));
        }
      } else {
        stateBtn.className = "stateBtn fa-solid fa-minus red";
      }

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = gift.titre;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = "Sélectionné par : " + gift.selectionne_par.join(", ");

      const labelWrap = document.createElement("div");
      labelWrap.style.minWidth = "0";
      labelWrap.appendChild(title);
      if (gift.etat === "selectionne_par_plusieurs") {
        labelWrap.appendChild(meta);
      }

      left.appendChild(stateBtn);
      left.appendChild(labelWrap);

      const right = document.createElement("div");

      const delBtn = document.createElement("i");
      delBtn.className = "delBtn fa-solid fa-trash" + (!canDelete ? " disabled" : "");
      delBtn.title = canDelete ? "Supprimer ce cadeau" : "Impossible (sélectionné ou pas auteur)";
      if (canDelete) {
        delBtn.addEventListener("click", () => deleteGift(selectedUser, gift.id));
      }

      right.appendChild(delBtn);

      row.appendChild(left);
      row.appendChild(right);
      list.appendChild(row);
    });

    // Ajout cadeau
    const input = document.getElementById("giftInput");
    input.value = "";
    input.placeholder = `Ajouter un cadeau pour ${selectedUser}...`;

    const addBtn = document.getElementById("addBtn");
    addBtn.onclick = () => addGift(selectedUser, input.value.trim(), me);
    input.onkeydown = (e) => {
      if (e.key === "Enter") addGift(selectedUser, input.value.trim(), me);
    };
  }

  // -------- Logique clic (cycle / contraintes)
  function toggleStateForGift(ownerName, giftId){
    const block = getUserBlock(ownerName);
    if (!block) return;

    const gift = block.cadeaux.find(g => g.id === giftId);
    if (!gift) return;

    const hasMe = gift.selectionne_par.includes(me);

    switch(gift.etat) {

      case "deselectionne":
        gift.selectionne_par.push(me);
        gift.etat = "selectionne";
        break;

      case "selectionne":
        gift.etat = "selectionne_par_plusieurs";
        break;

      default:
        if (gift.selectionne_par.length === 1 && hasMe){
            gift.selectionne_par = [];
            gift.etat = "deselectionne";
        }
        if (gift.selectionne_par.length > 1 && hasMe){
          const others = gift.selectionne_par.filter(x => x !== me);
          gift.selectionne_par = others;
        }
        if (!hasMe){
          gift.selectionne_par.push(me);
        }
    }

    save();
    render();
  }

  function addGift(ownerName, title, author){
    if (!title) return;

    const block = getUserBlock(ownerName);
    if (!block) return;

    // auteur = propriétaire de la liste
    const newGift = {
      id: `${ownerName.toLowerCase()}-${Date.now()}`,
      titre: title,
      auteur: author,
      etat: "deselectionne",
      selectionne_par: []
    };

    block.cadeaux = block.cadeaux || [];
    block.cadeaux.push(newGift);

    save();
    render();
  }

  function deleteGift(ownerName, giftId){
    const block = getUserBlock(ownerName);
    if (!block) return;

    const idx = block.cadeaux.findIndex(g => g.id === giftId);
    if (idx === -1) return;

    const g = block.cadeaux[idx];

    block.cadeaux.splice(idx, 1);
    save();
    render();
  }

  // -------- Menu mobile
  function openMenu(){
    document.getElementById("overlay").classList.add("show");
    document.getElementById("drawer").classList.add("open");
  }

  function closeMenu(){
    document.getElementById("overlay").classList.remove("show");
    document.getElementById("drawer").classList.remove("open");
  }

  function openHelp(){
    document.getElementById("helpModal").classList.add("show");
  }

  function closeHelp(){
    document.getElementById("helpModal").classList.remove("show");
  }

  function logout(){
    sessionStorage.clear();
    window.location.href = "index.html";
  }

  // -------- Init
  (async function init(){

    await loadDB();
    await loadMenu();

    selectedUser = menu.includes(me) ? me : menu[0];

    render();
  })();
</script>

</body>
</html>
